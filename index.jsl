// index.js
import makeWASocket, {
    fetchLatestBaileysVersion,
    DisconnectReason,
} from '@whiskeysockets/baileys';
import { useMultiFileAuthState } from '@whiskeysockets/baileys';
import P from 'pino';

async function startBot() {
    const { state, saveCreds } = await useMultiFileAuthState('auth');
    const { version } = await fetchLatestBaileysVersion();
    console.log('Using WA v' + version.join('.'));

    const sock = makeWASocket({
        version,
        auth: state,
        printQRInTerminal: true,
        logger: P({ level: 'silent' }),
    });

    sock.ev.on('creds.update', saveCreds);

    sock.ev.on('connection.update', (update) => {
        const { connection, lastDisconnect, qr } = update;
        if (qr) console.log('ğŸ“± Ø§Ù…Ø³Ø­ QR ÙˆØ§ØªØ³Ø§Ø¨: ', qr);
        if (connection === 'close') {
            const shouldReconnect =
                (lastDisconnect.error?.output?.statusCode !== DisconnectReason.loggedOut);
            console.log('Connection closed. Reconnecting:', shouldReconnect);
            if (shouldReconnect) startBot();
        } else if (connection === 'open') {
            console.log('âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­!');
        }
    });

    // ğŸ“¨ Ø§Ù„Ø±Ø¯ÙˆØ¯ Ø¹Ù„Ù‰ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„ÙØ±Ø¯ÙŠØ©
    sock.ev.on('messages.upsert', async (m) => {
        const msg = m.messages[0];
        if (!msg.message || msg.key.fromMe) return;

        const text =
            msg.message.conversation ||
            msg.message.extendedTextMessage?.text;
        const from = msg.key.remoteJid;
        if (!text) return;

        const lowerText = text.toLowerCase();

        switch (lowerText) {
            case '!hello':
                await sock.sendMessage(from, { text: 'ğŸ‘‹ Ø£Ù‡Ù„Ø§Ù‹ ÙˆØ³Ù‡Ù„Ø§Ù‹! Ø£Ù†Ø§ Ø¨ÙˆØªÙƒ Ø§Ù„Ø±Ø§Ø¦Ø¹ âœ¨' });
                break;
            case '!menu':
                await sock.sendMessage(from, {
                    text: `ğŸ“œ *Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£ÙˆØ§Ù…Ø±:*
1ï¸âƒ£ !hello - ØªØ­ÙŠØ©
2ï¸âƒ£ !menu - Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£ÙˆØ§Ù…Ø±
3ï¸âƒ£ !time - Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ø­Ø§Ù„ÙŠ
4ï¸âƒ£ !ping - Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø¨ÙˆØª
5ï¸âƒ£ !sticker - ØªØ­ÙˆÙŠÙ„ ØµÙˆØ±Ø© Ù„Ù…Ù„ØµÙ‚
6ï¸âƒ£ !photo - Ø¥Ø±Ø³Ø§Ù„ ØµÙˆØ±Ø© Ø¹Ø´ÙˆØ§Ø¦ÙŠØ©
7ï¸âƒ£ !bye - ÙˆØ¯Ø§Ø¹
âš¡ï¸ ÙŠØ¯Ø¹Ù… Ø§Ù„Ø±Ø¯ÙˆØ¯ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ© ÙˆØ§Ù„ÙƒÙ„Ù…Ø§Øª`
                });
                break;
            case '!time':
                await sock.sendMessage(from, { text: `â° Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ø­Ø§Ù„ÙŠ: ${new Date().toLocaleString()}` });
                break;
            case '!ping':
                await sock.sendMessage(from, { text: 'ğŸ“ Pong!' });
                break;
            case '!bye':
                await sock.sendMessage(from, { text: 'ğŸ‘‹ Ø¨Ø§ÙŠ Ø¨Ø§ÙŠ! Ù†Ù„ØªÙ‚ÙŠ Ù‚Ø±ÙŠØ¨Ø§Ù‹ âœ¨' });
                break;
            case '!photo':
                await sock.sendMessage(from, {
                    image: { url: 'https://picsum.photos/300/300' },
                    caption: 'ğŸ“· ØµÙˆØ±Ø© Ø¹Ø´ÙˆØ§Ø¦ÙŠØ© Ù„Ùƒ!',
                });
                break;
            case '!sticker':
                await sock.sendMessage(from, { sticker: { url: 'https://picsum.photos/200/200' } });
                break;
            default:
                if (lowerText.includes('Ù…Ø±Ø­Ø¨Ø§')) {
                    await sock.sendMessage(from, { text: 'ğŸŒŸ Ø£Ù‡Ù„Ø§Ù‹! ÙƒÙŠÙ Ø­Ø§Ù„Ùƒ Ø§Ù„ÙŠÙˆÙ…ØŸ' });
                } else if (lowerText.includes('ÙƒÙŠÙÙƒ')) {
                    await sock.sendMessage(from, { text: 'ğŸ˜ Ø£Ù†Ø§ Ø¨Ø®ÙŠØ±! Ø´ÙƒØ±Ø§Ù‹ Ù„Ø³Ø¤Ø§Ù„Ùƒ âœ¨' });
                } else if (lowerText.includes('Ø´ÙƒØ±Ø§Ù‹')) {
                    await sock.sendMessage(from, { text: 'ğŸ™ Ø§Ù„Ø¹ÙÙˆ! Ø£ÙŠ ÙˆÙ‚Øª ğŸ˜' });
                }
                break;
        }
    });

    // ğŸ‘¥ Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª
    sock.ev.on('group-participants.update', async (update) => {
        const groupId = update.id;
        for (let participant of update.participants) {
            if (update.action === 'add') {
                await sock.sendMessage(groupId, {
                    text: `ğŸ‰ Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ @${participant.split('@')[0]} ÙÙŠ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©!`,
                    mentions: [participant],
                });
            } else if (update.action === 'remove') {
                await sock.sendMessage(groupId, {
                    text: `ğŸ‘‹ ÙˆØ¯Ø§Ø¹Ø§Ù‹ @${participant.split('@')[0]}ØŒ Ù†Ø±Ø§Ùƒ Ù‚Ø±ÙŠØ¨Ø§Ù‹!`,
                    mentions: [participant],
                });
            }
        }
    });

    sock.ev.on('groups.update', async (groups) => {
        for (let g of groups) {
            if (g.subject) {
                await sock.sendMessage(g.id, { text: `ğŸ“ ØªÙ… ØªØºÙŠÙŠØ± Ø§Ø³Ù… Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ø¥Ù„Ù‰: ${g.subject}` });
            }
            if (g.restrict) {
                await sock.sendMessage(g.id, { text: 'âš ï¸ ØªÙ… ØªÙ‚ÙŠÙŠØ¯ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª ÙÙŠ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©!' });
            }
        }
    });
}

startBot();
